<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="author" content="Ryan McGeary" />
<meta name="description" content="I received an interesting piece of hardware in the mail the other day. American Express is piggy-backing on LegalZoom document deliveries with an interesting piece of marketing – a USB key-like dev..." />
<meta name="og:title" content="Reverse Engineering an American Express USB WebKey" />
<meta name="og:description" content="I received an interesting piece of hardware in the mail the other day. American Express is piggy-backing on LegalZoom document deliveries with an interesting piece of marketing – a USB key-like dev..." />
<meta name="og:site_name" content="Ryan McGeary" />
<meta name="og:image" content="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/amex-usb-card.jpg" />
<meta name="twitter:image" content="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/amex-usb-card.jpg" />
<meta name="og:image" content="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/amex-usb-key.jpg" />

<meta name="og:image" content="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/teensy.jpg" />

<meta name="og:image" content="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/amex-usb-chip.jpg" />

<meta name="og:image" content="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/winchiphead-ch341a-ic.jpg" />

<meta name="og:image" content="http://ryan.mcgeary.org/images/ryan.mcgeary.jpg" />

<meta name="twitter:site" content="@rmm5t" />
<meta name="twitter:creator" content="@rmm5t" />
<meta name="og:type" content="article" />
<meta name="article:published_time" content="2015-05-25T18:00:00-06:00" />
<meta name="article:tag" content="tech" />
<meta name="keywords" content="tech" />
<meta name="twitter:card" content="summary_large_image" />
<title>Reverse Engineering an American Express USB WebKey - Ryan McGeary</title>
<link rel="alternate" type="application/atom+xml" title="Ryan McGeary Blog Posts" href="http://feeds.feedburner.com/ryanmcgeary" />
<link type="image/x-icon" href="/favicon.ico" rel="icon" />
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
<!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv-printshiv.min.js" type="text/javascript"></script>
<![endif]-->
</head>
<body class='x2015 x2015_05 x2015_05_26 x2015_05_26_reverse-engineering-american-express-usb-webkey x2015_05_26_reverse-engineering-american-express-usb-webkey_index'>
<div id='background'></div>
<div id='photo'><img src="/images/ryan.mcgeary.png" /></div>
<header data-offset-top='15' data-spy='affix' id='masthead' role='banner'>
<p class='sr-only'><a rel="home" href="/">Ryan McGeary</a></p>
<div class='sm-controls'>
<a class="btn" data-toggle="class" data-target="#sidebar, #background, #photo, #masthead .logo" data-class="expand" href="#"><i class='fa fa-bars fa-2x'></i>
</a></div>
<div class='logo'><a href="/">Ryan McGeary</a></div>
</header>
<section id='sidebar'>
<div class='container'>
<aside>
<h2 id="about-me">About Me</h2>

<p><a href="/">Ryan McGeary</a> is a software consultant, business starter,
rubyist, web guru, CrossFit enthusiast, and amateur
triathlete. Ryan owns <a href="http://mcgearygroup.com">McGeary Consulting
Group</a> and is the founder of
<a href="http://busyconf.com">BusyConf</a> and
<a href="http://chargestack.com">ChargeStack</a>. He lives near Boulder,
Colorado.</p>

<p><a href="https://twitter.com/intent/follow?screen_name=rmm5t">Follow me</a>, <a href="https://www.linkedin.com/in/ryanmcgeary">view my
résumé</a>, or
<a href="http://feeds.feedburner.com/ryanmcgeary">subscribe</a>.</p>


</aside>
<nav>
<h2><a href="/blog/">Recent</a></h2>
<ul class='list-unstyled'>
<li>
<a href="/2015/05/26/reverse-engineering-american-express-usb-webkey/">Reverse Engineering an American Express USB WebKey</a>
</li>
<li>
<a href="/2015/05/22/rejuvenating-my-piece-of-the-interwebs/">Rejuvenating My Piece of the Interwebs</a>
</li>
<li>
<a href="/2015/05/12/cloud-services-you-should-be-using-to-build-your-startup/">Talk: Cloud Services You Should Be Using To Build Your Startup</a>
</li>
<li>
<a href="/2014/08/20/html5-autocomplete-cheatsheet/">HTML5 Autocomplete Cheatsheet</a>
</li>
<li>
<a href="/2014/02/19/busyconf-1-million-cups-st-pete/">Talk: The BusyConf Story</a>
</li>
<li>
<a href="/2013/12/20/interview-with-eventtech-podcast/">Interview with #EventTech Podcast</a>
</li>
</ul>
<h2><a href="/blog/">Topics</a></h2>
<ul class='list-unstyled'>
<li>
<a href="/screencasts/">screencasts</a>
</li>
<li>
<a href="/talks/">talks</a>
</li>
<li>
<a href="/programming/">programming</a>
</li>
<li>
<a href="/business/">business</a>
</li>
<li>
<a href="/tech/">tech</a>
</li>
<li>
<a href="/interviews/">interviews</a>
</li>
<li>
<a href="/podcasts/">podcasts</a>
</li>
<li>
<a href="/personal/">personal</a>
</li>
</ul>
<h2><a href="/blog/">Archive</a></h2>
<ul class='list-unstyled'>
<li>
<a href="/2015/">2015</a>
</li>
<li>
<a href="/2014/">2014</a>
</li>
<li>
<a href="/2013/">2013</a>
</li>
<li>
<a href="/2012/">2012</a>
</li>
<li>
<a href="/2011/">2011</a>
</li>
<li>
<a href="/2010/">2010</a>
</li>
<li>
<a href="/2008/">2008</a>
</li>
</ul>
</nav>
<aside>
<h2><a href="http://feeds.feedburner.com/ryanmcgeary">RSS</a></h2>
</aside>
<footer>
Copyright &copy; 2015
<br>
Ryan McGeary
<br>
All rights reserved.
</footer>
</div>
<footer></footer>
</section>
<div class='content-wrapper'>
<section id='content'>
<div class='container'><article>
<h1>
Reverse Engineering an American Express USB WebKey
<small class='text-nowrap'>May 26, 2015</small>
</h1>


<p>I received an interesting piece of hardware in the mail the other
day. American Express is piggy-backing on LegalZoom document deliveries with
an interesting piece of marketing – a USB key-like devices in the shape of a
credit card.</p>

<p><img alt="American Express Fake USB Keyboard" src="/2015/05/26/reverse-engineering-american-express-usb-webkey/amex-usb-card.jpg" /></p>

<p>Thinking it was a USB drive and one that I might be able to format and reuse
for something else, I plugged it in to my Mac. To my surprise, it immediately
opened Safari and a website pointing to an American Express credit card
offer. Huh? I thought OS X didn’t have Autorun support. So, of course, I tried
it again. This time, I noticed that the address bar in Safari scrolled as if
someone was typing really fast.</p>

<p><strong><em>Holy trickery, Batman. It’s mimicking a USB keyboard!</em></strong></p>

<p>Here are the steps that it takes:</p>

<ul>
  <li><kbd>⌃F3</kbd> to focus the Dock</li>
  <li>Types: <code>Safari</code></li>
  <li><kbd>return</kbd> to launch Safari</li>
  <li><kbd>⌘L</kbd> to focus the address bar</li>
  <li>Types: <code>http://www262.americanexpress.com/landing-page/business-cards/sclp/bgold/aff0022/44460?PID=15&amp;BUID=SBS&amp;PSKU=BGR&amp;CRTV=LZBGRLTOWBKYREF15</code></li>
  <li><kbd>return</kbd> to launch site</li>
</ul>

<p>NOTE: If Safari isn’t running or pinned to your Dock, the entire process
fails. They probably would have been better served to start with
<kbd>⌘-space</kbd> and a Spotlight search instead.</p>

<h2 id="digging-in">Digging In</h2>

<p>My curiosity was piqued, and this reminded me of the
<a href="http://samy.pl/usbdriveby/">USBdriveby</a> project that
<a href="http://samy.pl/">Samy Kamkar</a> discussed on a recent
<a href="http://fourhourworkweek.com/2015/05/02/samy-kamkar/">Tim Ferriss podcast</a>.</p>

<p>I wondered if I could reprogram this American Express USB device to behave in a
similar way as the <a href="https://www.pjrc.com/teensy/">Teensy USB Microcontroller</a>
that Samy used.</p>

<figure>
<img src="/2015/05/26/reverse-engineering-american-express-usb-webkey/amex-usb-key.jpg" />
<figcaption>"AmEx USB Stick" snapped from it's marketing enclosure.</figcaption>
</figure>

<figure>
<img src="/2015/05/26/reverse-engineering-american-express-usb-webkey/teensy.jpg" />
<figcaption>Teensy 3.1</figcaption>
</figure>

<h3 id="find-the-usb-device">Find the USB Device</h3>

<p>First, let’s see what OS X thinks about this USB device. We’ll do that by
inspecting all USB devices both before and after plugging in the USB key. The
difference will help us find the device itself.</p>

<pre class="highlight shell"><code>system_profiler SPUSBDataType &gt; ~/usbout.txt
system_profiler SPUSBDataType &gt; ~/usbin.txt
diff ~/usbout.txt ~/usbin.txt
</code></pre>

<p>This should yield a result like the following:</p>

<pre class="highlight diff"><code>33a34,44
&gt;         WEBKEY:
&gt;
&gt;           Product ID: 0x6662
&gt;           Vendor ID: 0x05ac  (Apple Inc.)
&gt;           Version: 8.15
&gt;           Speed: Up to 12 Mb/sec
&gt;           Manufacturer: TP6662
&gt;           Location ID: 0x14500000 / 27
&gt;           Current Available (mA): 500
&gt;           Current Required (mA): 100
</code></pre>

<p>Note the <code>Product ID</code> and <code>Vendor ID</code> values. We’ll need those later.</p>

<p><strong>I find it fairly suspicious that it mimics hardware from “Apple Inc.” Kinda sketchy.</strong></p>

<h3 id="now-what">Now What?</h3>

<p>At this point, I was immediately stuck, but after some research, I found a
superuser question on Stack Exchange titled
<em><a href="http://superuser.com/questions/131897/can-i-reprogram-an-american-express-usb-drive">Can I “reprogram” an American Express USB drive</a>?</em>
No direct answers, but this answer gave me hope:</p>

<blockquote>
  <p><em>It consists of a Cypress PSoC controller, combined with a 24c02 serial
eeprom … With a simple program called PonyProg you can read and modify the
contents of the eeprom.</em>
<a href="http://superuser.com/a/216810/8424">http://superuser.com/a/216810/8424</a></p>
</blockquote>

<p>I spun my wheels for a long while with no luck, but later, I found an article
titled
<em><a href="http://blog.opensecurityresearch.com/2012/10/hacking-usb-webkeys.html">Hacking USB Webkeys</a></em>. This
looked promising.</p>

<h3 id="hardware-surgery-and-failure">Hardware Surgery (<em><strong>and Failure</strong></em>)</h3>

<p>I slowly pried the chip from it’s plastic enclosure. It was attached with some glue.</p>

<figure>
<img src="/2015/05/26/reverse-engineering-american-express-usb-webkey/amex-usb-chip.jpg" />
<figcaption>"AmEx USB Chip" torn from it's plastic enclosure.</figcaption>
</figure>

<p>Sweet. Contact points that I should be able to use to access the EEPROM.</p>

<p>All seemed well, <em>until</em> I tested the webkey again. I must have damaged
something, because it now skips every 5th to 8th character as it emulates a
keyboard. Shoot. Maybe next time.</p>

<h3 id="lets-pretend-to-read-all-the-eeprom">Let’s [<em>Pretend to</em>] Read all the EEPROM</h3>

<blockquote>
  <p><em><strong>Disclaimer</strong>: I wasn’t able to test any of this, because I damaged my
hardware, but I encourage others to carry on where I left off and let me
know if you have any success!</em></p>
</blockquote>

<p>As it turns out, <a href="http://www.lancos.com/prog.html">PonyProg</a> (the program
mentioned on the Stack Exchange post) doesn’t work on OS X, but I found a
program called <a href="https://github.com/commandtab/ch341eeprom">ch341eeprom</a> that
claimed to perform a similar task.</p>

<p>It depends on the <a href="http://www.amazon.com/s/ref=as_li_ss_tl?_encoding=UTF8&amp;camp=1789&amp;creative=390957&amp;field-keywords=CH341A&amp;linkCode=ur2&amp;rh=i%3Aaps%2Ck%3ACH341A&amp;tag=rmm5t-20&amp;url=search-alias%3Daps&amp;linkId=FO43SQPQTVQ5OK43">WinChipHead CH341A</a>.</p>

<figure>
<img src="/2015/05/26/reverse-engineering-american-express-usb-webkey/winchiphead-ch341a-ic.jpg" />
<figcaption>WinChipHead CH341A</figcaption>
</figure>

<p>It also depends on <code>libusb</code>, so let’s install that using
<a href="http://brew.sh/">Homebrew</a> and then clone the repository so we can compile
<code>ch341eeprom</code>.</p>

<pre class="highlight shell"><code>brew install libusb
git clone https://github.com/commandtab/ch341eeprom.git
<span class="nb">cd </span>ch341eeprom
</code></pre>

<p>Compile, and try to read the eeprom:</p>

<pre class="highlight shell"><code>make
ch341eeprom -v -s 24c02 -r ~/eeprom.bin
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>While my attempt at hacking this hardware resulted in catastrophic failure,
don’t let that stop you from trying something new or breaking down an unknown
piece of tech. I learned a lot during this little investigative project, and if I find
another free marketing webkey in the mail, I just might pick-up where I left
off.</p>



<hr>
<p>
<em>
Please
<a href="https://twitter.com/intent/tweet?hashtags=tech&amp;size=large&amp;text=Reverse+Engineering+an+American+Express+USB+WebKey&amp;url=http%3A%2F%2Fryan.mcgeary.org%2F2015%2F05%2F26%2Freverse-engineering-american-express-usb-webkey%2F&amp;via=rmm5t">share</a>.
Also
<a href="https://twitter.com/intent/follow?screen_name=rmm5t">follow me</a>
for more.
</em>
</p>
<hr>
<a class="twitter-share-button" data-url="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/" data-text="Reverse Engineering an American Express USB WebKey" data-via="rmm5t" data-size="large" data-hashtags="tech" href="https://twitter.com/share">Tweet</a>
<a class="twitter-follow-button" data-show-count="true" data-size="large" href="https://twitter.com/rmm5t">Follow @rmm5t</a>
<br>
<div class="g-plus" data-action="share" data-annotation="bubble" data-href="http://ryan.mcgeary.org/2015/05/26/reverse-engineering-american-express-usb-webkey/" data-height="28"></div>


</article>
</div>
</section>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js" type="text/javascript"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js" type="text/javascript"></script>
<script src="/javascripts/all.js" type="text/javascript"></script>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-604149-3', 'auto');
  ga('send', 'pageview');
</script>
<script src="https://apis.google.com/js/platform.js" type="text/javascript" async="true" defer="defer"></script>
</body>
</html>
