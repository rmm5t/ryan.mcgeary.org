<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="author" content="Ryan McGeary" />
<meta name="description" content="I use GitHub Pages for hosting some of my websites, and I use the Middleman static site generator as my content management system for some of these sites.I like to run continuous integration for my..." />
<meta name="og:title" content="Continuous Integration and Deployment with Middleman, Codeship, and GitHub Pages" />
<meta name="og:description" content="I use GitHub Pages for hosting some of my websites, and I use the Middleman static site generator as my content management system for some of these sites.I like to run continuous integration for my..." />
<meta name="og:site_name" content="Ryan McGeary" />
<meta name="og:image" content="http://ryan.mcgeary.org/images/ryan.mcgeary.jpg" />
<meta name="twitter:image" content="http://ryan.mcgeary.org/images/ryan.mcgeary.jpg" />
<meta name="twitter:site" content="@rmm5t" />
<meta name="twitter:creator" content="@rmm5t" />
<meta name="og:type" content="article" />
<meta name="article:published_time" content="2013-12-18T17:00:00-07:00" />
<meta name="article:tag" content="programming" />
<meta name="keywords" content="programming" />
<meta name="twitter:card" content="summary_large_image" />
<title>Continuous Integration and Deployment with Middleman, Codeship, and GitHub Pages - Ryan McGeary</title>
<link rel="alternate" type="application/atom+xml" title="Ryan McGeary Blog Posts" href="http://feeds.feedburner.com/ryanmcgeary" />
<link type="image/x-icon" href="/favicon.ico" rel="icon" />
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
<!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv-printshiv.min.js" type="text/javascript"></script>
<![endif]-->
</head>
<body class='x2013 x2013_12 x2013_12_19 x2013_12_19_continuous-integration-deployment-middleman-codeship-github-pages x2013_12_19_continuous-integration-deployment-middleman-codeship-github-pages_index'>
<div id='background'></div>
<div class='hidden-xs' id='photo'><img src="/images/ryan.mcgeary.png" /></div>
<header data-offset-top='15' data-spy='affix' id='masthead' role='banner'>
<p class='sr-only'><a rel="home" href="/">Ryan McGeary</a></p>
<div class='sm-controls'>
<a class="btn" data-toggle="class" data-target="#sidebar, #background, #photo, #masthead .logo" data-class="expand" href="#"><i class='fa fa-bars fa-2x'></i>
</a></div>
<div class='logo'><a href="/">Ryan McGeary</a></div>
</header>
<section id='sidebar'>
<div class='container'>
<aside>
<h2 id="about-me">About Me</h2>

<p><a href="/">Ryan McGeary</a> is a software consultant, business starter,
rubyist, web guru, CrossFit enthusiast, and amateur
triathlete. Ryan owns <a href="http://mcgearygroup.com">McGeary Consulting
Group</a> and is the founder of
<a href="http://busyconf.com">BusyConf</a> and
<a href="http://chargestack.com">ChargeStack</a>. He lives near Boulder,
Colorado.</p>

<p><a href="https://twitter.com/intent/follow?screen_name=rmm5t">Follow me</a>, <a href="https://www.linkedin.com/in/ryanmcgeary">view my
résumé</a>, or
<a href="http://feeds.feedburner.com/ryanmcgeary">subscribe</a>.</p>


</aside>
<nav>
<h2><a href="/blog/">Recent</a></h2>
<ul class='list-unstyled'>
<li>
<a href="/2015/05/22/rejuvenating-my-piece-of-the-interwebs/">Rejuvenating My Piece of the Interwebs</a>
</li>
<li>
<a href="/2015/05/12/cloud-services-you-should-be-using-to-build-your-startup/">Talk: Cloud Services You Should Be Using To Build Your Startup</a>
</li>
<li>
<a href="/2014/08/20/html5-autocomplete-cheatsheet/">HTML5 Autocomplete Cheatsheet</a>
</li>
<li>
<a href="/2014/02/19/busyconf-1-million-cups-st-pete/">Talk: The BusyConf Story</a>
</li>
<li>
<a href="/2013/12/20/interview-with-eventtech-podcast/">Interview with #EventTech Podcast</a>
</li>
<li>
<a href="/2013/12/19/continuous-integration-deployment-middleman-codeship-github-pages/">Continuous Integration and Deployment with Middleman, Codeship, and GitHub Pages</a>
</li>
</ul>
<h2><a href="/blog/">Topics</a></h2>
<ul class='list-unstyled'>
<li>
<a href="/screencasts/">screencasts</a>
</li>
<li>
<a href="/talks/">talks</a>
</li>
<li>
<a href="/programming/">programming</a>
</li>
<li>
<a href="/business/">business</a>
</li>
<li>
<a href="/tech/">tech</a>
</li>
<li>
<a href="/interviews/">interviews</a>
</li>
<li>
<a href="/podcasts/">podcasts</a>
</li>
<li>
<a href="/personal/">personal</a>
</li>
</ul>
<h2><a href="/blog/">Archive</a></h2>
<ul class='list-unstyled'>
<li>
<a href="/2015/">2015</a>
</li>
<li>
<a href="/2014/">2014</a>
</li>
<li>
<a href="/2013/">2013</a>
</li>
<li>
<a href="/2012/">2012</a>
</li>
<li>
<a href="/2011/">2011</a>
</li>
<li>
<a href="/2010/">2010</a>
</li>
<li>
<a href="/2008/">2008</a>
</li>
</ul>
</nav>
<aside>
<h2><a href="http://feeds.feedburner.com/ryanmcgeary">RSS</a></h2>
</aside>
<footer>
Copyright &copy; 2015
<br>
Ryan McGeary
<br>
All rights reserved.
</footer>
</div>
<footer></footer>
</section>
<div class='content-wrapper'>
<section id='content'>
<div class='container'><article>
<h1>
Continuous Integration and Deployment with Middleman, Codeship, and GitHub Pages
<small class='text-nowrap'>Dec 19, 2013</small>
</h1>
<p>I use <a href="http://pages.github.com/">GitHub Pages</a> for hosting some of my
websites, and I use the <a href="http://middlemanapp.com/">Middleman</a> static site
generator as my content management system for some of these sites.</p>

<p>I like to run continuous integration for my projects whenever possible, and
this goes for static site repositories as much as regular code repositories.</p>

<p>Recently, I started playing with
<a href="https://www.codeship.io/?referral_token=suhjnfd0sdye885fstjjsfyo0">Codeship</a>. It’s
a well-priced continuous integration and deployment service, and I wanted to
be able to automatically deploy my middleman site upon successful builds to
the master branch. It took a bit of trial and error, but I finally got
something that works well.</p>

<h2 id="test-settings">Test Settings</h2>

<p>After initializing a new GitHub repository in Codeship, you’ll need to define
how tests are run. Under the <em>Test</em> project settings in Codeship, select
<em>Ruby</em> as the language and define your <em>Setup Commands</em> and <em>Test Commands</em>.</p>

<h3 id="setup-commands">Setup Commands:</h3>

<pre class="highlight shell"><code>bundle install
</code></pre>

<h3 id="test-commands">Test Commands:</h3>

<pre class="highlight shell"><code>bundle <span class="nb">exec </span>middleman build
</code></pre>

<p>Perfect. Now your site will run a test build upon every code push.</p>

<h2 id="deployment-settings">Deployment Settings</h2>

<p>This is where I had some trouble, but I finally found a set of commands that
correctly deloyed to our <code>gh-pages</code> branch in the repository. First, it’s
worth mentioning that I use the
<a href="https://github.com/neo/middleman-gh-pages">middleman-gh-pages</a> gem for
deploying to the <code>gh-pages</code> branch. This gem gives you a <code>rake publish</code> task
that handles most of the dirty work.</p>

<p>Under the <em>Deployment</em> project settings in Codeship, configure a deployment
from the master branch using a <em>Custom Script</em>.</p>

<h3 id="custom-script">Custom Script:</h3>

<pre class="highlight shell"><code>git config --global user.email <span class="s2">"robot@example.com"</span>
git config --global user.name <span class="s2">"Codeship Robot"</span>
rm -rf build
git remote <span class="nb">set</span>-branches --add origin gh-pages
git fetch
bundle <span class="nb">exec </span>rake publish
sleep 30
wget --retry-connrefused --no-check-certificate -T 60 http://yoursite.com/
</code></pre>

<p>This configures a git user, removes the <code>build</code> directory that was left there
from the test steps, adds a <code>gh-pages</code> remote branch (because Codeship only
clones the relevant branch during setup), and runs the <code>rake publish</code> task to
deploy the site to the <code>gh-pages</code> branch.</p>

<p>If all went well, your site will automatically deploy to GitHub Pages upon a
push and successful build in the master branch.</p>

<h3 id="github-publishing-caveat">GitHub Publishing Caveat</h3>

<p>Make sure the email address that you use for this git user is a verified email
address in your GitHub account. Otherwise, GitHub will accept the commit, but
it will not publish the changes to your site. To fully make everything work,
you will need to do one of two things: 1) Move the Codeship deploy key to an
SSH key in your own GitHub account OR 2) Create a new machine user on GitHub
and move the Codeship deploy key to an SSH key on that user account, give that
machine user push/pull access to the repository, and make sure that machine
user’s email address is fully verified by GitHub. I highly recommend going
with option #2.</p>

<h2 id="extra-credit-force-codeship-to-skip-builds-on-the-gh-pages-branch">Extra Credit: Force Codeship to skip builds on the gh-pages branch.</h2>

<p>Unfortunately, Codeship currently tries to run builds on all branches,
including the <code>gh-pages</code> branch. This is undesirable for this setup, so to
avoid this, we also need to add “–skip-ci” or “[skip ci]” to the commit
message that is pushed to the gh-pages branch.</p>

<p>Fortunately, after
<a href="https://github.com/neo/middleman-gh-pages/pull/16">this pull-request</a> by
yours truly, middleman-gh-pages can support that.</p>

<p>If using version &gt;= 0.0.3 (or the master branch), you can add this to the
bottom of your project’s Rakefile:</p>

<pre class="highlight shell"><code><span class="c"># Ensure builds are skipped when pushing to the gh-pages branch</span>
ENV[<span class="s2">"COMMIT_MESSAGE_SUFFIX"</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"[skip ci]"</span>
</code></pre>


<hr>
<p>
<em>
Please
<a href="https://twitter.com/intent/tweet?hashtags=programming&amp;size=large&amp;text=Continuous+Integration+and+Deployment+with+Middleman%2C+Codeship%2C+and+GitHub+Pages&amp;url=http%3A%2F%2Fryan.mcgeary.org%2F2013%2F12%2F19%2Fcontinuous-integration-deployment-middleman-codeship-github-pages%2F&amp;via=rmm5t">share</a>, <a href="https://twitter.com/intent/tweet?in_reply_to=414061931272892416">reply to comment</a>, or <a href="https://twitter.com/intent/retweet?tweet_id=414061931272892416">retweet</a>.
Also
<a href="https://twitter.com/intent/follow?screen_name=rmm5t">follow me</a>
for more.
</em>
</p>
<hr>
<a class="twitter-share-button" data-url="http://ryan.mcgeary.org/2013/12/19/continuous-integration-deployment-middleman-codeship-github-pages/" data-text="Continuous Integration and Deployment with Middleman, Codeship, and GitHub Pages" data-via="rmm5t" data-size="large" data-hashtags="programming" href="https://twitter.com/share">Tweet</a>
<a class="twitter-follow-button" data-show-count="true" data-size="large" href="https://twitter.com/rmm5t">Follow @rmm5t</a>
<br>
<div class="g-plus" data-action="share" data-annotation="bubble" data-href="http://ryan.mcgeary.org/2013/12/19/continuous-integration-deployment-middleman-codeship-github-pages/" data-height="28"></div>


</article>
</div>
</section>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js" type="text/javascript"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js" type="text/javascript"></script>
<script src="/javascripts/all.js" type="text/javascript"></script>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-604149-3', 'auto');
  ga('send', 'pageview');
</script>
<script src="https://apis.google.com/js/platform.js" type="text/javascript" async="true" defer="defer"></script>
</body>
</html>
